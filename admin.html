window.jarvisAIScan = async () => {
    const query = document.getElementById('aiQuery').value;
    const log = document.getElementById('aiLog');
    const btn = document.getElementById('aiStatusBtn');
    
    if(!query) return alert("Sir, please enter a product name.");

    log.innerText = "Connecting to Neural Core...";
    log.style.color = "var(--gold)";
    btn.innerText = "SCANNING";
    btn.disabled = true;

    try {
        // Updated API endpoint and stronger prompt
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                contents: [{ 
                    parts: [{ 
                        text: `Return ONLY a valid JSON object for the product "${query}". 
                        Format: {"name": "full name", "brand": "brand", "price": 12000, "category": "Mobile", "specs": "3 bullet points"}. 
                        Do not include markdown, backticks, or any text other than the JSON.` 
                    }] 
                }]
            })
        });

        const data = await resp.json();
        
        // Error handling for API Quota or Key issues
        if(data.error) {
            throw new Error(data.error.message);
        }

        let rawText = data.candidates[0].content.parts[0].text.trim();
        
        // ðŸ§¼ CLEANING DATA: Removes any non-JSON characters
        const start = rawText.indexOf('{');
        const end = rawText.lastIndexOf('}') + 1;
        const cleanJson = rawText.substring(start, end);
        
        const res = JSON.parse(cleanJson);

        // ðŸ’‰ Injecting into fields
        document.getElementById('pName').value = res.name || "";
        document.getElementById('pBrand').value = (res.brand || "").toUpperCase();
        document.getElementById('pPrice').value = res.price || "";
        document.getElementById('pCat').value = res.category.includes("Mobile") ? "Mobile" : "Accessories";
        document.getElementById('pDesc').value = res.specs || "";

        log.innerText = "Neural Link Stable. Data Injected.";
        log.style.color = "var(--green)";
        btn.innerText = "DONE";

    } catch (e) {
        console.error("Jarvis Error Log:", e);
        log.innerText = "Link Failed. (Check Console F12 for details)";
        log.style.color = "var(--red)";
        btn.innerText = "RETRY";
    } finally {
        btn.disabled = false;
        setTimeout(() => { 
            btn.innerText = "SCAN"; 
            log.style.color = "#555"; 
        }, 3000);
    }
};
