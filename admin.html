// ðŸ§  UPGRADED JARVIS AI SCAN (FIXED)
window.jarvisAIScan = async () => {
    const query = document.getElementById('aiQuery').value;
    const log = document.getElementById('aiLog');
    const btn = document.getElementById('aiStatusBtn');
    
    if(!query) return alert("Sir, enter a product name first.");

    log.innerText = "Initializing Neural Link...";
    log.style.color = "var(--gold)";
    btn.innerText = "SCANNING";
    btn.disabled = true;

    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                contents: [{ 
                    parts: [{ 
                        text: `Search for ${query}. You are a product database. Return ONLY a raw JSON object (strictly no markdown, no backticks, no conversation) with these keys: {"name": "full name", "brand": "brand name", "price": "numeric price only", "category": "Mobile or Accessories", "specs": "brief bullet points"}.` 
                    }] 
                }]
            })
        });

        const data = await resp.json();
        
        // Safety check for API response
        if(!data.candidates || !data.candidates[0].content) {
            throw new Error("Invalid API Response");
        }

        let rawText = data.candidates[0].content.parts[0].text;
        
        // Clean markdown if present
        let cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
        
        // Parse data
        const res = JSON.parse(cleanJson);

        // Injecting into fields
        document.getElementById('pName').value = res.name || "";
        document.getElementById('pBrand').value = (res.brand || "").toUpperCase();
        document.getElementById('pPrice').value = res.price ? res.price.toString().replace(/\D/g, "") : "";
        document.getElementById('pCat').value = res.category.includes("Mobile") ? "Mobile" : "Accessories";
        document.getElementById('pDesc').value = res.specs || "";

        log.innerText = "Neural Link Stable. Injection Complete.";
        log.style.color = "var(--green)";
        btn.innerText = "SUCCESS";
    } catch (e) {
        console.error("Jarvis Neural Error:", e);
        log.innerText = "Link Failed: System busy or key restricted.";
        log.style.color = "var(--red)";
        btn.innerText = "RETRY";
    } finally {
        btn.disabled = false;
        setTimeout(() => { 
            btn.innerText = "SCAN"; 
            log.style.color = "#555";
        }, 3000);
    }
};
