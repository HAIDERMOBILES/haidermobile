<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haider Mobiles | Central Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --bg: #050505; --card: #111; --border: #222; --green: #25d366; --neon: #00f3ff; --red: #ff4757; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        .admin-container { max-width: 1300px; margin: 0 auto; }
        
        /* ‚ú® Header */
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .logo-text { font-family: 'Orbitron'; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; }

        /* üöÄ Product Upload Section */
        .upload-section { background: rgba(212, 175, 55, 0.03); padding: 25px; border-radius: 15px; border: 1px solid var(--gold); margin-bottom: 40px; box-shadow: 0 0 20px rgba(212,175,55,0.1); }
        .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        /* üìä Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; transition: 0.3s; }
        .stat-card:hover { border-color: var(--gold); }
        .stat-card h4 { font-size: 10px; font-family: 'Orbitron'; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .stat-card p { font-size: 26px; font-weight: 800; color: var(--gold); margin: 0; }

        /* üîç Inputs & Tables */
        .input-field { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); border-radius: 8px; color: #fff; outline: none; margin-bottom: 10px; font-size: 13px; box-sizing: border-box; }
        .input-field:focus { border-color: var(--gold); }
        
        .table-wrap { background: var(--card); border-radius: 15px; overflow-x: auto; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #1a1a1a; color: var(--gold); padding: 15px; text-align: left; font-size: 11px; font-family: 'Orbitron'; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid #1a1a1a; font-size: 13px; vertical-align: top; }
        
        /* üü¢ Status & Buttons */
        .status-select { background: #000; color: var(--neon); border: 1px solid var(--neon); border-radius: 5px; padding: 6px; font-size: 10px; font-family: 'Orbitron'; cursor: pointer; outline: none; }
        .btn { padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; border: none; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; font-family: 'Orbitron'; }
        .btn-gold { background: var(--gold); color: #000; width: 100%; justify-content: center; }
        .btn-gold:hover { background: #fff; transform: translateY(-2px); }
        .btn-del { background: #222; color: var(--red); border: 1px solid #333; padding: 8px 12px; }
        .btn-del:hover { background: var(--red); color: #fff; }
        .btn-wa { background: var(--green); color: #fff; text-decoration: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-family: sans-serif; }
        
        .order-item { background: #080808; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #1a1a1a; border-left: 4px solid var(--gold); }
        .img-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; vertical-align: middle; margin-right: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="admin-container">
    <div class="header-box">
        <h2 class="logo-text"><i class="fa fa-shuttle-space"></i> CENTRAL_COMMAND</h2>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#222; color:#fff" onclick="location.reload()"><i class="fa fa-sync"></i> REFRESH</button>
            <a href="index.html" target="_blank" class="btn btn-gold" style="width:auto"><i class="fa fa-external-link"></i> LIVE SITE</a>
        </div>
    </div>

    <div class="upload-section">
        <h3 style="color:var(--gold); font-family:'Orbitron'; font-size:13px; margin-bottom:20px; letter-spacing: 2px;">
            <i class="fa fa-plus-circle"></i> ADD_NEW_INVENTORY_UNIT
        </h3>
        <div class="upload-grid">
            <input type="text" id="pName" placeholder="Unit Name (e.g. Realme 65W Charger)" class="input-field">
            <input type="number" id="pPrice" placeholder="Price (PKR)" class="input-field">
            
            <select id="pCat" class="input-field">
                <option value="" disabled selected>SELECT_CATEGORY</option>
                <option value="Cables">Cables</option>
                <option value="Chargers">Chargers</option>
                <option value="Car Charger">Car Charger</option>
                <option value="Clip Charger">Clip Charger</option>
                <option value="Card Reader">Card Reader</option>
                <option value="Neck Band">Neck Band</option>
                <option value="Earbuds">Earbuds</option>
                <option value="Handfree">Handfree</option>
                <option value="Speaker">Speaker</option>
                <option value="Power Banks">Power Banks</option>
                <option value="OTG Connectors">OTG Connectors</option>
                <option value="Battery">Battery</option>
                <option value="HeadPhones">Headphones</option>
            </select>

            <input type="text" id="pBrand" placeholder="Brand Name" class="input-field">
            <input type="text" id="pImg" placeholder="Direct Image URL (ImgBB)" class="input-field">
        </div>
        <button onclick="window.uploadProduct()" class="btn btn-gold" style="margin-top:15px;">DEPLOY_TO_TERMINAL</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><h4>System Users</h4><p id="totalUsers">0</p></div>
        <div class="stat-card"><h4>Lifetime Orders</h4><p id="totalOrders">0</p></div>
        <div class="stat-card"><h4>Action Required</h4><p id="pendingOrders" style="color:var(--neon);">0</p></div>
    </div>

    <input type="text" id="adminSearch" class="input-field" placeholder="Search by customer name, phone, CNIC or status..." style="margin-bottom: 20px; border-color: #333;">

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>CUSTOMER_INTEL</th>
                    <th>SECURE_ID_&_PHONE</th>
                    <th>ORDER_MANIFEST</th>
                    <th>OPERATIONS</th>
                </tr>
            </thead>
            <tbody id="adminTable"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCYzkMGDwWZGx_PlrNfjloYZ6PVQRne9wg",
        authDomain: "web-app-4f3a1.firebaseapp.com",
        projectId: "web-app-4f3a1",
        databaseURL: "https://web-app-4f3a1-default-rtdb.firebaseio.com",
        appId: "1:222099203820:web:778e204d2960181dfba7c9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- üöÄ PRODUCT UPLOAD LOGIC ---
    window.uploadProduct = () => {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        const cat = document.getElementById('pCat').value;
        const brand = document.getElementById('pBrand').value;
        const img = document.getElementById('pImg').value;

        if(!name || !price || !cat || !img) {
            alert("Sir, missing data packets. Ensure Name, Price, Category and Image URL are present.");
            return;
        }

        const newProductRef = push(ref(db, 'products'));
        set(newProductRef, {
            name,
            price: parseInt(price),
            category: cat,
            brand: brand || "Generic",
            img,
            timestamp: Date.now()
        }).then(() => {
            alert("UNIT DEPLOYED: Product is now live on the frontend.");
            ['pName', 'pPrice', 'pBrand', 'pImg'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('pCat').value = "";
        });
    };

    // --- üîÑ ORDER & USER MANAGEMENT ---
    onValue(ref(db, 'users'), (snapshot) => {
        const adminTable = document.getElementById('adminTable');
        adminTable.innerHTML = "";
        let uCount = 0, oCount = 0, pCount = 0;

        if(!snapshot.exists()) return;

        snapshot.forEach((child) => {
            uCount++;
            const uid = child.key;
            const user = child.val();
            const orders = user.orders || {};

            let orderHtml = "";
            Object.keys(orders).reverse().forEach(oid => {
                oCount++;
                const order = orders[oid];
                if(order.status === "Pending") pCount++;
                
                orderHtml += `
                    <div class="order-item">
                        <div style="margin-bottom:5px;">
                            <span style="color:var(--gold)">#</span> <b>${order.items || 'Units'}</b>
                        </div>
                        <div style="font-size:10px; color:#666; margin-bottom:8px;">TIMESTAMP: ${order.date || 'Unknown'}</div>
                        <select class="status-select" onchange="window.updateStatus('${uid}', '${oid}', this)">
                            <option value="Pending" ${order.status==='Pending'?'selected':''}>PENDING</option>
                            <option value="Shipped" ${order.status==='Shipped'?'selected':''}>SHIPPED</option>
                            <option value="Delivered" ${order.status==='Delivered'?'selected':''}>DELIVERED</option>
                        </select>
                    </div>`;
            });

            adminTable.innerHTML += `
                <tr class="user-row">
                    <td>
                        <div style="font-weight:700; color:var(--gold); font-family:'Orbitron'; font-size:12px;">${user.name || 'Anonymous User'}</div>
                        <div style="color:#888; font-size:11px;">${user.email || 'No Email'}</div>
                    </td>
                    <td>
                        <div style="font-family:monospace;">${user.phone || 'N/A'}</div>
                        <div style="color:#555; font-size:10px; margin-top:4px;">CNIC: ${user.cnic || 'NOT_FOUND'}</div>
                    </td>
                    <td>${orderHtml || '<span style="color:#333; font-style:italic;">No active transmissions</span>'}</td>
                    <td>
                        <div style="display:flex; gap:8px;">
                            <a href="https://wa.me/${user.phone}" class="btn btn-wa" target="_blank"><i class="fab fa-whatsapp"></i></a>
                            <button class="btn btn-del" onclick="window.deleteUser('${uid}')"><i class="fa fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
        });

        document.getElementById('totalUsers').innerText = uCount;
        document.getElementById('totalOrders').innerText = oCount;
        document.getElementById('pendingOrders').innerText = pCount;
    });

    window.updateStatus = (uid, oid, elem) => {
        update(ref(db, `users/${uid}/orders/${oid}`), { status: elem.value })
        .then(() => console.log("System Sync: Order status updated."));
    };

    window.deleteUser = (uid) => {
        if(confirm("DANGER: This will erase all user data and order history. Proceed?")) {
            remove(ref(db, `users/${uid}`));
        }
    };

    // üîç Search Logic
    document.getElementById('adminSearch').oninput = (e) => {
        const val = e.target.value.toLowerCase();
        document.querySelectorAll('.user-row').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    };
</script>
</body>
</html>
