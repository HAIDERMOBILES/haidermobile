<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword, updateEmail, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCYzkMGDwWZGx_PlrNfjloYZ6PVQRne9wg",
        authDomain: "web-app-4f3a1.firebaseapp.com",
        projectId: "web-app-4f3a1",
        databaseURL: "https://web-app-4f3a1-default-rtdb.firebaseio.com",
        storageBucket: "web-app-4f3a1.firebasestorage.app",
        messagingSenderId: "222099203820",
        appId: "1:222099203820:web:778e204d2960181dfba7c9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('userEmailHeader').innerText = user.email;
            document.getElementById('dbEmail').value = user.email;
            
            // 1. Load Profile Info
            onValue(ref(db, 'users/' + user.uid), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('dbName').value = data.name || "";
                    document.getElementById('dbPhone').value = data.phone || "";
                    document.getElementById('userNameHeader').innerText = data.name || "User";
                    if(data.pic) document.getElementById('userAvatar').src = data.pic;
                }
            });

            // 2. Load Real Orders from Database
            onValue(ref(db, 'users/' + user.uid + '/orders'), (snapshot) => {
                const orderList = document.getElementById('orderList');
                if (snapshot.exists()) {
                    orderList.innerHTML = "";
                    snapshot.forEach((child) => {
                        const order = child.val();
                        orderList.innerHTML += `
                            <tr>
                                <td>#${child.key.slice(-5).toUpperCase()}</td>
                                <td>${order.date}</td>
                                <td>${order.items}</td>
                                <td style="color:var(--gold)">${order.total}</td>
                                <td><span class="order-tag">${order.status}</span></td>
                            </tr>
                        `;
                    });
                }
            });
        } else {
            window.location.href = "login.html";
        }
    });

    // Picture Upload Fix
    window.uploadProfilePic = async (input) => {
        const file = input.files[0];
        if(!file) return;

        const formData = new FormData();
        formData.append('image', file);

        document.getElementById('userAvatar').style.opacity = "0.5";
        
        try {
            const response = await fetch('https://api.imgbb.com/1/upload?key=638680e66838a53e6b2160655d04588d', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if(data.success) {
                const url = data.data.display_url;
                await update(ref(db, 'users/' + auth.currentUser.uid), { pic: url });
                document.getElementById('userAvatar').src = url;
                alert("✅ Picture Updated!");
            }
        } catch (e) {
            alert("Upload failed. Check internet!");
        } finally {
            document.getElementById('userAvatar').style.opacity = "1";
        }
    }

    // Tab Logic
    window.openTab = (evt, tabName) => {
        const contents = document.querySelectorAll(".content-section");
        const btns = document.querySelectorAll(".tab-btn");
        contents.forEach(c => c.style.display = "none");
        btns.forEach(b => b.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }

    // Profile Update Logic
    window.updateProfile = async () => {
        const user = auth.currentUser;
        const name = document.getElementById('dbName').value;
        const phone = document.getElementById('dbPhone').value;
        const email = document.getElementById('dbEmail').value;
        const pass = document.getElementById('dbPass').value;

        try {
            await update(ref(db, 'users/' + user.uid), { name, phone });
            if(email !== user.email) await updateEmail(user, email);
            if(pass !== "") await updatePassword(user, pass);
            alert("✨ Details Updated!");
        } catch (e) {
            alert("For Security: Please logout and login again to change Email/Password.");
        }
    }

    window.handleLogout = () => { signOut(auth).then(() => window.location.href = "index.html"); }
</script>
