<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCYzkMGDwWZGx_PlrNfjloYZ6PVQRne9wg",
        authDomain: "web-app-4f3a1.firebaseapp.com",
        projectId: "web-app-4f3a1",
        databaseURL: "https://web-app-4f3a1-default-rtdb.firebaseio.com",
        storageBucket: "web-app-4f3a1.firebasestorage.app",
        messagingSenderId: "222099203820",
        appId: "1:222099203820:web:778e204d2960181dfba7c9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const productId = new URLSearchParams(window.location.search).get('id');

    // BADLAO: Window ke saath attach karna zaroori hai
    window.updateBadge = () => {
        const cart = JSON.parse(localStorage.getItem('haider_cart')) || [];
        const b = document.getElementById('cartCount');
        if(cart.length > 0) { b.innerText = cart.length; b.style.display = 'block'; }
        else { b.style.display = 'none'; }
    };
    window.updateBadge();

    window.addToCart = (name, price, img) => {
        let cart = JSON.parse(localStorage.getItem('haider_cart')) || [];
        cart.push({name, price, img});
        localStorage.setItem('haider_cart', JSON.stringify(cart));
        window.updateBadge();
        alert("âœ… Added to Bag!");
    };

    if (productId) {
        onValue(ref(db, 'products/' + productId), (snapshot) => {
            const p = snapshot.val();
            if (p) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                const images = [p.img, p.img2, p.img3].filter(u => u && u.trim() !== "");
                
                // Thumbs function ko bhi window se attach kiya taake onclick chale
                window.changeImg = (url, el) => {
                    document.getElementById('mImg').src = url;
                    document.querySelectorAll('.thumb-row img').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                };

                let thumbs = images.length > 1 ? images.map((u, i) => 
                    `<img src="${u}" onclick="window.changeImg('${u}', this)" class="${i===0?'active':''}">`
                ).join('') : '';

                document.getElementById('main-content').innerHTML = `
                    <div class="product-header">
                        <span class="brand-label">Premium Collection</span>
                        <h1>${p.name}</h1>
                    </div>
                    <div class="apple-wrapper">
                        <div class="slider-section">
                            <div class="main-img"><img id="mImg" src="${images[0]}"></div>
                            <div class="thumb-row">${thumbs}</div>
                        </div>
                        <div class="info-section">
                            <span class="price-current">${p.price}</span>
                            <div class="main-desc" style="color:#86868b; margin-top:15px;">${p.description || 'Premium details...'}</div>
                            <div class="btn-group">
                                <div class="add-cart-btn" onclick="window.addToCart('${p.name}', '${p.price}', '${p.img}')">Add to Bag</div>
                                <a href="https://wa.me/923279518790?text=Salam! I want to buy: ${p.name}" class="buy-btn">Order on WhatsApp</a>
                            </div>
                        </div>
                    </div>`;
            }
        });
    }
</script>
